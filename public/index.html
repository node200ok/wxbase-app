
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Wxbase测试</title>
		
		<link rel="stylesheet" href="/lib/modern/css/modern.css" />
		<link rel="stylesheet" href="/lib/modern/css/modern-responsive.css" />
		<style>
			@media (min-width: 980px) {
				#container {
					width: 980px;
					margin: auto;
				}
			}
			
			#form-send fieldset {
				display: none;
				margin-top: 45px;
				padding-top: 0;
			}
			#form-send fieldset.open {
				display: block;
			}
			#form-send fieldset legend {
				font-size: 16pt;
				top: -30px;
			}
			#form-send .bottom {
				margin-top: 15px;
			}
			#form-send textarea {
				resize: none;
			}
		</style>
	</head>
	<body>
		<div id="container">
			<div class="page">
				<div class="nav-bar">
					<div class="nav-bar-inner padding10">
						<span class="pull-menu"></span>
						<a>
							<span class="element brand">
								WxBase-App <small>0.0.2</small>
							</span>
						</a>
					</div>
				</div>
			</div>
			
			<div class="page">
				<div class="page-header">
					<div class="page-header-content">
						<h1>Wxbase<small>测试</small></h1>
					</div>
				</div>
			</div>
			<div class="page secondary">
				<div class="page-region">
		            <div class="page-region-content">
		            	<div class="grid">
		            		<div class="row">
		            			<div class="span10">
		            				<form id="form-send">
	            						<h3>用户名</h3>
	            						<div class="input-control text">
											<input type="text" id="from-user-name" value="test-user" />
										</div>
										<input type="hidden" id="to-user-name" value="the-host" />
		            					
		            					<h3>消息类型</h3>
	            						<div class="input-control select">
		                                    <select id="msg-type">
												<option value="text">文本</option>
												<option value="voice">语音</option>
												<option value="image">图片</option>
												<option value="location">位置</option>
												<option value="event">事件</option>
											</select>
		                                </div>
										
										<fieldset data-type="text">
											<legend>文本消息</legend>
											<h3>内容</h3>
											<div class="input-control textarea">
												<textarea data-name="content"></textarea>
											</div>
										</fieldset>
										<fieldset data-type="image">
											<legend>图片消息</legend>
											<h3>URL</h3>
											<div class="input-control text">
												<input type="url" data-name="picUrl" />
											</div>
										</fieldset>
										<fieldset data-type="location">
											<legend>位置消息</legend>
											<h3>X坐标</h3>
											<div class="input-control text">
												<input type="number" data-name="locationX" value="120" />
											</div>
											<h3>Y坐标</h3>
											<div class="input-control text">
												<input type="number" data-name="locationY" value="30" />
											</div>
											<h3>缩放</h3>
											<div class="input-control text">
												<input type="number" data-name="scale" value="1" />
											</div>
											<h3>地理标签</h3>
											<div class="input-control text">
												<input type="text" data-name="label" value="洪湖公园" />
											</div>
										</fieldset>
										<fieldset data-type="event">
											<legend>事件消息</legend>
											<h3>事件类型</h3>
											<div class="input-control select">
												<select data-name="event">
													<option value="subscribe">订阅</option>
													<option value="CLICK">按键</option>
												</select>
											</div>
											<h3>按键值</h3>
											<div class="input-control text">
												<input type="text" data-name="eventKey" value="key-2013" />
											</div>
										</fieldset>
										
										<div class="bottom">
											<input type="submit" value="发送" />
											<input type="reset" value="重置" />
										</div>
									</form>
									
									<div id="log"></div>
		            			</div>
		            		</div>
		            	</div>
					</div>
				</div>
				
				<div class="page">
					<div class="nav-bar">
						<div class="nav-bar-inner padding10">
							<span class="element">
								2013, Wxbase-App © by <a class="fg-color-white" href="https://github.com/node200ok">n200ok</a>.
								&nbsp;&nbsp;&nbsp;&nbsp;
								Styled by <a href="https://github.com/olton/Metro-UI-CSS" class="fg-color-white">Metro UI CSS</a>
							</span>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<script src="/lib/underscore/underscore-min.js"></script>
		<script src="/lib/jquery/jquery.min.js"></script>
		<script src="/lib/modern/js/input-control.js"></script>
		<script src="/lib/wx-parser.js"></script>
		<script>
			var $form = $('#form-send'),
				$fieldsets = $form.find('fieldset'),
				$log = $('#log'),
				currMsgType;
			
			// toggle fieldsets
			$form.find('#msg-type').on('change', function() {
				var msgType = currMsgType = $(this).val();
				$fieldsets.removeClass('open')
					.filter('[data-type="'+ msgType +'"]').addClass('open');
			}).trigger('change');
			
			// log empty
			$form.on('change reset', function() {
				$log.empty();
			});
			
			// fieldset-event
			var $fsEvent = $fieldsets.filter('[data-type="event"]');
			$fsEvent.find('[data-name="event"]').on('change', function() {
				$fsEvent.find('[data-name="eventKey"]')
					.attr('disabled', $(this).val() !== 'CLICK');
			}).trigger('change');
			
			// form submit
			$form.on('submit', function(ev) {
				ev.preventDefault();
				
				var msgType = currMsgType, reqObj = {
					fromUserName: $form.find('#from-user-name').val(),
					toUserName: $form.find('#to-user-name').val(),
					createTime: new Date().getTime(),
					//MsgId: parseInt(Math.random() * 999999999),
					msgType: msgType
				};
				$fieldsets.filter('[data-type="'+ msgType +'"]')
					.find('[data-name]').each(function(i, el) {
						var key = $(el).attr('data-name'),
							value = $(el).val();
						reqObj[key] = value;
					});
				
				var reqXml = wxToXml(reqObj);
				$log.empty().append([
					'<p>', 'sent: ' + JSON.stringify(reqObj), '</p>'
				].join(''));
				$.ajax({
					type: 'post',
					url: '/wx',
					processData: false,
					data: reqXml,
					beforeSend: function(xhr){
						xhr.setRequestHeader('Content-Type', 'text/plain');
					},
					success: function(resXml) {
						var resObj = wxToObj(resXml);
						$log.append([
							'<p>', 'received: ' + JSON.stringify(resObj), '</p>'
						]);
					}
				});
			});
		</script>
	</body>
</html>
